<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Musical Introduction to Generators • async</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="A Musical Introduction to Generators">
<meta property="og:description" content="async">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">async</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/clapping.html">A Musical Introduction to Generators</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/crowding/async/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="clapping_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>A Musical Introduction to Generators</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/crowding/async/blob/HEAD/vignettes/clapping.Rmd" class="external-link"><code>vignettes/clapping.Rmd</code></a></small>
      <div class="hidden name"><code>clapping.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="a-musical-introduction-to-generators">A Musical Introduction to Generators<a class="anchor" aria-label="anchor" href="#a-musical-introduction-to-generators"></a>
</h2>
<p>What a generator allows you to do is to take code that is writen in a sequential, looping style, and then treat that code’s output as a collection to be iterated over.</p>
<p>To illustrate what this means, and the the generators package in general, I will use R to perform a suitable piece of music, specifically Steve Reich’s “Clapping Music.”</p>
<p>The piece is starts with a loop counting out groups of 3, 2, 1, 2, 3, 2, 1, 2, 3… with each group seperated by one rest. This adds up to a 12-note loop:</p>
<div class="figure">
<img src="clapping_music.svg" alt=""><p class="caption">Musical score showing loop</p>
</div>
<p>In code, we could implement that idea like the following, printing a <code>1</code> for each clap and a <code>0</code> for each rest:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print_pattern</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">counts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">repeats</span><span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">repeats</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="va">counts</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">c</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Testing this, we should see groups of 1, 2, or 3 <code>1</code>s separated by a single <code>0</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_pattern</span><span class="op">(</span>repeats<span class="op">=</span><span class="fl">4</span><span class="op">)</span>;</span></code></pre></div>
<pre><code><span><span class="co">## 111011010110111011010110111011010110111011010110</span></span></code></pre>
<p>“Clapping Music” is based on manipulating this 12-count loop. But it’s hard to manipulate the output of a program that only prints. The calls to <code>cat</code> produce output on the terminal, but they don’t produce data that we can easily manipulate with more programming – we need to make this pattern into data, rather than terminal output.</p>
<p>The <code>generators</code> package allows us to enclose a data-generating process into an object.</p>
<p>To make a generator for this patter, we just enclose the body of the function in a call to <code><a href="../reference/gen.html">gen()</a></code>, and change each <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code> to <code><a href="../reference/gen.html">yield()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://crowding.github.io/async/" class="external-link">async</a></span><span class="op">)</span> <span class="co"># for gen</span></span>
<span><span class="va">gen_pattern</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">counts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/gen.html">gen</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">repeat</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="va">counts</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="../reference/gen.html">yield</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="../reference/gen.html">yield</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Adding <code>force(counts)</code> is a good idea because of R’s lazy evaluation + mutable bindings. A generator captures its environment like an inner function, so it’s a good idea to fix the value of <code>counts</code> before the outer function returns; this is the same as if you return an inner function that uses arguments to an outer function. Meanwhile, fixing the number of <code>repeats</code> ahead of time is no longer necessary; a generator can be in principle infinite and it will only generate data as long as you keep requesting more.</p>
<p>The code inside <code>gen(...)</code> does not run, yet. The call to <code>gen</code> constructs an [iterator][iterators::iterators-package], which supports the method <code>nextElem</code>. When <code><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem()</a></code> is called on a generator, the generator runs its code only up to the point where <code>yield</code> is called. The generator returns this value, and pauses state until the next call to <code><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/iterators" class="external-link">iterators</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">gen_pattern</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">23</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span>; <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 11101101011011101101011</span></span></code></pre>
<p><code>gen(...)</code> constructs and returns an <a href="https://CRAN.R-project.org/package=iterators" class="external-link">iterator</a>, which means you can apply iterator methods to it. For instance you can collect just the first 24 items with <code>ilimit()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">show_head</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">n</span><span class="op">=</span><span class="fl">24</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">itertools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/itertools/man/ilimit.html" class="external-link">ilimit</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span>sep<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">show_head</span><span class="op">(</span><span class="fu">gen_pattern</span><span class="op">(</span><span class="op">)</span>, <span class="fl">24</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## list(1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, </span></span>
<span><span class="co">##     1, 0, 1, 1, 0)</span></span></code></pre>
<div class="section level3">
<h3 id="making-noise">Making noise<a class="anchor" aria-label="anchor" href="#making-noise"></a>
</h3>
<p>We’re a good way into what I advertised as a musical endeavour and haven’t made any sounds yet. First let’s download some handclap samples. I located some on GitHub:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">baseurl</span> <span class="op">&lt;-</span> <span class="st">"https://github.com/octoblu/drum-kit/raw/master/public/assets/samples"</span></span>
<span><span class="va">samplepaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span> <span class="op">=</span> <span class="st">"/clap4.wav"</span>,<span class="st">"X"</span> <span class="op">=</span> <span class="st">"/clap5.wav"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/curl/man/curl_download.html" class="external-link">curl_download</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">baseurl</span>, <span class="st">"/clap%20(4).WAV"</span><span class="op">)</span>, <span class="va">samplepaths</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/curl/man/curl_download.html" class="external-link">curl_download</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">baseurl</span>, <span class="st">"/clap%20(5).WAV"</span><span class="op">)</span>, <span class="va">samplepaths</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Although R is not known for audio performance, there is an <code>audio</code> package playing sound samples, which we can use like this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/audio/" class="external-link">audio</a></span><span class="op">)</span> <span class="co"># for load.wave, play</span></span>
<span><span class="va">claps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">samplepaths</span>, <span class="va">load.wave</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/audio/man/play.html" class="external-link">play</a></span><span class="op">(</span><span class="va">claps</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/audio/man/play.html" class="external-link">play</a></span><span class="op">(</span><span class="va">claps</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>We want to play sounds at a consistent tempo, so here’s a routine that takes in a generator and a sample list, and plays at a given tempo. The <code>profvis</code> package has a <code>pause</code> function that’s more accurate than <code><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep()</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/profvis/" class="external-link">profvis</a></span><span class="op">)</span> <span class="co"># for pause</span></span>
<span><span class="va">iplay</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">g</span>, <span class="va">samples</span>, <span class="va">bpm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">interval</span> <span class="op">&lt;-</span> <span class="fl">60</span> <span class="op">/</span> <span class="va">bpm</span></span>
<span>  <span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="kw">repeat</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span>      <span class="va">target</span> <span class="op">&lt;-</span> <span class="va">target</span> <span class="op">+</span> <span class="va">interval</span></span>
<span>      <span class="kw">while</span><span class="op">(</span><span class="op">{</span><span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">now</span> <span class="op">&gt;</span> <span class="fl">0.15</span><span class="op">}</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">target</span> <span class="op">-</span> <span class="va">now</span> <span class="op">-</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="va">x</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/profvis/man/pause.html" class="external-link">pause</a></span><span class="op">(</span><span class="va">target</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/audio/man/play.html" class="external-link">play</a></span><span class="op">(</span><span class="va">samples</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span>,</span>
<span>    error<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">'StopIteration'</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>      <span class="kw">else</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>So we should hear our pattern now:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gen_pattern</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">itertools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/itertools/man/ilimit.html" class="external-link">ilimit</a></span><span class="op">(</span><span class="fl">36</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">iplay</span><span class="op">(</span><span class="va">claps</span>, <span class="fl">360</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="some-iterator-functions">Some iterator functions<a class="anchor" aria-label="anchor" href="#some-iterator-functions"></a>
</h4>
<p>Here’s a couple of utility functions that will come in handy. One is an iterator equivalent of <code>lapply</code> for iterators, which I’ll call <code>iapply</code>. The other one is <code>isink</code> which just consumes all elements from an iterator.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iapply</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">it</span>, <span class="va">f</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">it</span>, <span class="va">f</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="fu">itertools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/itertools/man/util.html" class="external-link">new_iterator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">it</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">isink</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">it</span>, <span class="va">then</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="kw">repeat</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">it</span><span class="op">)</span><span class="op">}</span>,</span>
<span>    error<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">'StopIteration'</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span> <span class="va">then</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="some-iterator-functions-using-generators">Some iterator functions using generators<a class="anchor" aria-label="anchor" href="#some-iterator-functions-using-generators"></a>
</h4>
<p>Note that in a generator, you can write a <code>for</code> loop with an iterator in the argument. So we can equivalently write <code>iapply</code> and <code>isink</code> like this:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iapply</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">it</span>, <span class="va">f</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">it</span>, <span class="va">f</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/gen.html">gen</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">it</span><span class="op">)</span> <span class="fu"><a href="../reference/gen.html">yield</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">isink</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">it</span>, <span class="va">then</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/gen.html">gen</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">it</span><span class="op">)</span> <span class="kw">next</span></span>
<span>    <span class="fu"><a href="../reference/gen.html">yield</a></span><span class="op">(</span><span class="va">then</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For example, run an iterator through <code>iapply(cat)</code> and <code>isink</code> to print it:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">gen_pattern</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">itertools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/itertools/man/ilimit.html" class="external-link">ilimit</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/iapply.html" class="external-link">iapply</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">isink</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="phasing-and-combining">Phasing and combining<a class="anchor" aria-label="anchor" href="#phasing-and-combining"></a>
</h3>
<p>“Clapping Music” is a piece for two performers, who both play the same pattern, but after every 12 loops, one of the performers skips forward by one step. Over the course of the piece, the two parts move out and back into in phase with each other. We can write a generator function that does this “skip,” by consuming a value without yielding it:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drop_one_after</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">g</span>, <span class="va">n</span>, <span class="va">sep</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">g</span>, <span class="va">n</span>, <span class="va">sep</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/gen.html">gen</a></span><span class="op">(</span></span>
<span>    <span class="kw">repeat</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="../reference/gen.html">yield</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="co">#drop</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">sep</span><span class="op">)</span> <span class="co"># print a seperator after every skip</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here’s a count from one to 12, skipping after three (i.e. skipping every fourth):</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">iterators</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/icount.html" class="external-link">icount</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">itertools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/itertools/man/ilimit.html" class="external-link">ilimit</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">drop_one_after</span><span class="op">(</span><span class="fl">3</span>, <span class="st">"\n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/iapply.html" class="external-link">iapply</a></span><span class="op">(</span><span class="va">cat</span>, <span class="st">""</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu">isink</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The performance directions for “Clapping Music” request that the two performers should make their claps sound similar, so that their lines blend into an overall pattern. We can interpret that as combining the two lines by adding two generators, resulting in 0, 1, or 2 claps at every step, playing the louder sample for a value of 2.</p>
<p>Then, all together:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clapping_music</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">=</span><span class="fl">12</span>, <span class="va">counts</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, <span class="va">sep</span><span class="op">=</span><span class="st">" "</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">counts</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="co"># how long?</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">gen_pattern</span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">gen_pattern</span><span class="op">(</span><span class="va">counts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">drop_one_after</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">cell</span>, <span class="va">sep</span><span class="op">)</span></span>
<span>  <span class="co"># add them together and limit the output</span></span>
<span>  <span class="fu"><a href="../reference/gen.html">gen</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="op">(</span><span class="va">cell</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">cell</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/gen.html">yield</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/nextElem.html" class="external-link">nextElem</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To narrate this: we are constructing two independent instances of our 12-note generator. One of these patterns is made to skip one beat every N bars. Then we create a third generator that adds together the two.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">clapping_music</span><span class="op">(</span><span class="fl">4</span>, sep<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/iterators/man/iapply.html" class="external-link">iapply</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">isink</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a-performance">A performance<a class="anchor" aria-label="anchor" href="#a-performance"></a>
</h3>
<p>Now we should be able to hear our performance</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">iplay</span><span class="op">(</span><span class="fu">clapping_music</span><span class="op">(</span>n<span class="op">=</span><span class="fl">4</span>, sep<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span>, <span class="va">claps</span>, <span class="fl">480</span><span class="op">)</span></span></code></pre></div>
<p>R is definitely not a multimedia environment, plus the <code>audio</code> package is using the OS alert sound facility, which is not really meant for precise timing, so you may hear some glitches and hiccups. Nevertheless, I hope this has illustrated how generators allows control to be <em>interleaved</em> among different sequential processes.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Peter Meilstrup.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
