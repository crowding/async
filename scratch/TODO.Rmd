## Fixing "switch"

The current CPS version does not do branch fallthrough. To fix that I
would need to know during construction which arguments are missing.

R native "switch" does a thing where it can end up executing no arguments.

    switch(-1, "one", "two", "three") #takes no branch and returns NULL.

That behavior would be bad to use base R switch as a compiled version of switch, because it would end up falling off and not tailcalling.

Let's see, what about if you initialize a "mapping" at run time and then switch based on a label you pull out of there?

# ESS versus closxps?!

Apparently the reason I can't just tag a "class" attribute onto a closxp and call that an iteror is.... ESS is fucking with me. If I evaluate a chunk in ESS, it is altering the environment of the resulting closxp. it comes back with the enclosing environment set to the package namespace, instead of the environment that _really_ enclosed it and has its variables. It's weird.

# Name munging

### Switch in graphs

I need to do something tricky to make my implementation of `switch` traversable by `walk`. Like bquote() out a custom switch_cps. See [switch.R]().

### Speed of walking the graph.

There did appear to be some O(N^2) rearing their heads when walk()ing a graph. Run a profiler? There are definitely some O(n^2) data structures currently in there.

Assigning context names at runtime helps, though there is still a `contains` in `walk` and in `munge`.

I did something to make myself use hashbags more consistently and noticed a speedup! So there was def some list reallocation going on.

Interestingly, using a list by index isn't much slower than using an env until you get past 100 elements or so. But s3 dispatch and going through `hashbag()` is quite a bit slower. See [map_timings.Rmd](). So I might want to just use lists instead of hashbags. If I can keep them from having to copy themselves all the time.

## Emacs locking up when I pause in R debugger

Aargh, something is happening in ess-mode that makes emacs lock up waiting for a response when it's in the debugger. Can be triggered by ess-whatever-completions mode. Is triggered by just having point in an R buffer for a few seconds.

ESS output window keeps saying "Disabling output delimiter because CMD failed to parse."

This is likely because all my variable names in the compiled generators are fucky.

## it would be nice if name-munging twice were idempotent.

(i.e. ended up with the names and translated functions.) One way to do
that might be to not bother slapping context on the names of nodes in
the special "first" context encountered.)

## Fixing graphviz output on compiled generators

Graphviz does not like the new labels (clearly). Spend some time making sure that compiled generator's graphs look okay.

## Debugging tools

Make some methods that allow single stepping the R code, as well as to allow single stepping the "interior" code.

Setting "debugOnce" on pumpCont (whenever it's updated) would do it.

And an option for user-level stepping, evaluating "browser()" in the
target environment and single stepping.

Meanwhile, it might be good to do R's "eval" via a handler, so as to condense references to the target environment.

## Fix `switch` to work in compilation.

How does the current implementation of switch() even pass unit test with compilation on. It's because I only have one unit test for it, because I was waffling on how to implement it.
